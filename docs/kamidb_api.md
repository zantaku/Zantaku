# KamiDB API Documentation

This document provides comprehensive information on how to use the KamiDB API to build applications. KamiDB is a Supabase-powered API focused on anime and manga tracking, with features for user management, streaks, and rewards.

## Table of Contents

- [Getting Started](#getting-started)
  - [Authentication](#authentication)
  - [Base URL](#base-url)
  - [API Keys](#api-keys)
- [Core Resources](#core-resources)
  - [Anilist Users](#anilist-users)
  - [User Streaks](#user-streaks)
  - [Rewards](#rewards)
  - [User Rewards](#user-rewards)
- [Common Operations](#common-operations)
  - [Data Querying](#data-querying)
  - [Filtering](#filtering)
  - [Pagination](#pagination)
  - [Ordering](#ordering)
- [Realtime Subscriptions](#realtime-subscriptions)
- [Code Examples](#code-examples)
  - [JavaScript/TypeScript](#javascripttypescript)
  - [Python](#python)
  - [Flutter/Dart](#flutterdart)
- [Error Handling](#error-handling)
- [Rate Limits](#rate-limits)
- [Security Considerations](#security-considerations)

## Getting Started

### Base URL

All API requests should be made to the following base URL:

```
https://www.kamidb.online/rest/v1
```

### Authentication

KamiDB uses Supabase's authentication system, which requires an API key for all requests. For authenticated operations, you'll also need a JWT token.

#### API Keys

For public operations, use the anon key:

```
apikey: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlIjoiYW5vbiIsImlzcyI6InN1cGFiYXNlLWRlbW8iLCJpYXQiOjE2NDE3NjkyMDAsImV4cCI6MTc5OTUzNTYwMH0.dc_X5iR_VP_qT0zsiyj_I_OZ2T9FtRU2BBNWN8Bu4GE
```

#### JWT Tokens

**Yes, you need a JWT token for authenticated operations.** JWT (JSON Web Token) is required for:
- Operations that modify data (POST, PATCH, DELETE)
- Accessing user-specific data
- Operations that require specific permissions

The JWT tokens in KamiDB are:
- Generated by the auth service (GoTrue)
- Signed using a secret key (JWT_SECRET)
- Valid for 1 hour (JWT_EXPIRY=3600)
- Used across all services (auth, REST API, storage, functions, realtime, analytics)

The JWT secret used for signing tokens is:
```
JWT_SECRET=cZ7OenDpi20zZh0aXnxACg0tebda5vEGpmh6M1KWKhpVgzt291cZ7OenDpi20zZh0aXnxACg0tebda5vEGpmh6M1KWKhpVgzt291
```

To obtain a JWT token:

1. **User Sign Up/Sign In**: When a user signs up or signs in through Supabase Auth, a JWT is generated automatically.

```javascript
// Example: Sign in and get JWT
const { data, error } = await supabase.auth.signInWithPassword({
  email: 'user@example.com',
  password: 'password123'
})

// The JWT token is available at:
const jwt = data.session.access_token
```

2. **Include the JWT in requests**: For authenticated operations, include both the API key and the JWT in your request headers:

```
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJhdXRoZW50aWNhdGVkIiwiZXhwIjoxNjgzNjQyOTc2LCJzdWIiOiI1YzYzZmVlZS03MmYyLTQ0ZjYtOWZiZS0xZDIzMDJjZGQwODAiLCJlbWFpbCI6InVzZXJAZXhhbXBsZS5jb20iLCJyb2xlIjoiYXV0aGVudGljYXRlZCJ9.t9_inUYKGvzqJJXbXoILsrES_uwYVgKZ1tPuLPYQubQ
apikey: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlIjoiYW5vbiIsImlzcyI6InN1cGFiYXNlLWRlbW8iLCJpYXQiOjE2NDE3NjkyMDAsImV4cCI6MTc5OTUzNTYwMH0.dc_X5iR_VP_qT0zsiyj_I_OZ2T9FtRU2BBNWN8Bu4GE
```

3. **JWT Expiry**: JWT tokens expire after 1 hour. You'll need to refresh the token when it expires:

```javascript
// Check if session exists and refresh if needed
const { data, error } = await supabase.auth.refreshSession()
const newJwt = data.session?.access_token
```

4. **JWT Claims**: The JWT contains claims about the user, including:
- `sub`: The user's ID
- `email`: The user's email
- `role`: The user's role (e.g., 'authenticated')
- `aud`: The audience (e.g., 'authenticated')
- `exp`: Expiration timestamp
- `iat`: Issued at timestamp

#### Client Setup with JWT

Here's how to set up a client with both the API key and JWT:

```javascript
import { createClient } from '@supabase/supabase-js'

const supabaseUrl = 'https://www.kamidb.online'
const supabaseKey = 'your_anon_key'
const supabase = createClient(supabaseUrl, supabaseKey)

// Sign in to get JWT
async function signIn(email, password) {
  const { data, error } = await supabase.auth.signInWithPassword({
    email,
    password
  })
  
  if (error) {
    console.error('Error signing in:', error)
    return null
  }
  
  return data.session
}

// Example: Using JWT for authenticated operations
async function createUserWithAuth(session, userData) {
  // Supabase client automatically uses the JWT from the session
  const { data, error } = await supabase
    .from('anilist_users')
    .insert([userData])
    .select()
  
  if (error) {
    console.error('Error creating user:', error)
    return null
  }
  
  return data[0]
}
```

## Core Resources

### Anilist Users

The `anilist_users` table stores user information connected to Anilist accounts.

#### Schema

| Field | Type | Description |
|-------|------|-------------|
| id | uuid | Primary key |
| anilist_id | bigint | Unique Anilist ID |
| username | text | User's username |
| avatar_url | text | URL to user's avatar |
| access_token | text | Anilist access token |
| created_at | timestamp | Account creation time |
| updated_at | timestamp | Last update time |
| is_verified | boolean | Verification status |

#### Endpoints

- `GET /anilist_users` - List all users
- `GET /anilist_users?anilist_id=eq.123456` - Get user by Anilist ID
- `POST /anilist_users` - Create a new user
- `PATCH /anilist_users?id=eq.[uuid]` - Update a user
- `DELETE /anilist_users?id=eq.[uuid]` - Delete a user

### User Streaks

The `user_streaks` table tracks user activity streaks for anime and manga.

#### Schema

| Field | Type | Description |
|-------|------|-------------|
| id | uuid | Primary key |
| anilist_id | integer | Foreign key to anilist_users |
| last_active | date | Last activity date |
| current_streak | integer | Current streak count |
| longest_streak | integer | Longest streak achieved |
| type | text | Type (anime/manga/combo) |
| created_at | timestamp | Record creation time |
| updated_at | timestamp | Last update time |

#### Endpoints

- `GET /user_streaks` - List all streaks
- `GET /user_streaks?anilist_id=eq.123456` - Get streaks for specific user
- `POST /user_streaks` - Create a new streak
- `PATCH /user_streaks?id=eq.[uuid]` - Update a streak
- `DELETE /user_streaks?id=eq.[uuid]` - Delete a streak

### Rewards

The `rewards` table defines available rewards in the system.

#### Schema

| Field | Type | Description |
|-------|------|-------------|
| id | uuid | Primary key |
| name | text | Reward name |
| type | text | Type (anime/manga/combo) |
| description | text | Reward description |
| icon_url | text | URL to reward icon |
| unlock_criteria | jsonb | Criteria to unlock |
| created_at | timestamp | Record creation time |

#### Endpoints

- `GET /rewards` - List all rewards
- `GET /rewards?id=eq.[uuid]` - Get specific reward
- `POST /rewards` - Create a new reward
- `PATCH /rewards?id=eq.[uuid]` - Update a reward
- `DELETE /rewards?id=eq.[uuid]` - Delete a reward

### User Rewards

The `user_rewards` table tracks which rewards users have unlocked.

#### Schema

| Field | Type | Description |
|-------|------|-------------|
| id | uuid | Primary key |
| user_id | uuid | Foreign key to anilist_users |
| reward_id | uuid | Foreign key to rewards |
| unlocked_at | timestamp | When reward was unlocked |
| proof_data | jsonb | Proof of unlock criteria |

#### Endpoints

- `GET /user_rewards` - List all user rewards
- `GET /user_rewards?user_id=eq.[uuid]` - Get rewards for specific user
- `POST /user_rewards` - Create a new user reward
- `PATCH /user_rewards?id=eq.[uuid]` - Update a user reward
- `DELETE /user_rewards?id=eq.[uuid]` - Delete a user reward

## Common Operations

### Data Querying

KamiDB API supports powerful querying capabilities through Supabase:

#### Selecting Specific Fields

```http
GET /anilist_users?select=id,username,avatar_url
```

#### Joining Related Tables

```http
GET /anilist_users?select=id,username,user_streaks(current_streak,type)
```

### Filtering

Filter results using a variety of operators:

```http
GET /user_streaks?current_streak=gt.5
GET /anilist_users?username=ilike.*anime*
```

Common operators:
- `eq` - equal to
- `neq` - not equal to
- `gt` - greater than
- `lt` - less than
- `gte` - greater than or equal to
- `lte` - less than or equal to
- `like` - pattern matching (case sensitive)
- `ilike` - pattern matching (case insensitive)

### Pagination

Control the number of results returned:

```http
GET /anilist_users?limit=20&offset=0
```

### Ordering

Order results by any field:

```http
GET /user_streaks?order=current_streak.desc,last_active.asc
```

## Realtime Subscriptions

KamiDB supports real-time data subscriptions. Using Supabase client libraries, you can subscribe to changes in any table:

```javascript
const subscription = supabase
  .from('anilist_users')
  .on('INSERT', payload => {
    console.log('New user:', payload.new)
  })
  .on('UPDATE', payload => {
    console.log('Updated user:', payload.new)
  })
  .subscribe()
```

## Code Examples

### JavaScript/TypeScript

Using the Supabase JS client:

```javascript
import { createClient } from '@supabase/supabase-js'

const supabaseUrl = 'https://www.kamidb.online'
const supabaseKey = 'your_anon_key'
const supabase = createClient(supabaseUrl, supabaseKey)

// Get all users
async function getUsers() {
  const { data, error } = await supabase
    .from('anilist_users')
    .select('*')
  
  if (error) {
    console.error('Error fetching users:', error)
    return null
  }
  
  return data
}

// Create a new user
async function createUser(userData) {
  const { data, error } = await supabase
    .from('anilist_users')
    .insert([userData])
    .select()
  
  if (error) {
    console.error('Error creating user:', error)
    return null
  }
  
  return data[0]
}

// Update user streak
async function updateStreak(streakId, newData) {
  const { data, error } = await supabase
    .from('user_streaks')
    .update(newData)
    .eq('id', streakId)
    .select()
  
  if (error) {
    console.error('Error updating streak:', error)
    return null
  }
  
  return data[0]
}
```

### Python

Using the Supabase Python client:

```python
from supabase import create_client

url = "https://www.kamidb.online"
key = "your_anon_key"
supabase = create_client(url, key)

# Get all rewards
def get_rewards():
    response = supabase.table('rewards').select('*').execute()
    return response.data

# Get user with related streaks
def get_user_with_streaks(anilist_id):
    response = supabase.table('anilist_users') \
        .select('*, user_streaks(*)') \
        .eq('anilist_id', anilist_id) \
        .execute()
    return response.data[0] if response.data else None

# Create a user reward
def create_user_reward(user_id, reward_id, proof_data):
    data = {
        'user_id': user_id,
        'reward_id': reward_id,
        'proof_data': proof_data
    }
    response = supabase.table('user_rewards').insert(data).execute()
    return response.data[0] if response.data else None
```

### Flutter/Dart

Using the Supabase Flutter client:

```dart
import 'package:supabase_flutter/supabase_flutter.dart';

// Initialize Supabase
await Supabase.initialize(
  url: 'https://www.kamidb.online',
  anonKey: 'your_anon_key',
);

final supabase = Supabase.instance.client;

// Get user streaks
Future<List<Map<String, dynamic>>> getUserStreaks(int anilistId) async {
  final response = await supabase
      .from('user_streaks')
      .select()
      .eq('anilist_id', anilistId);
  
  if (response.error != null) {
    throw response.error!;
  }
  
  return response.data as List<Map<String, dynamic>>;
}

// Update user data
Future<Map<String, dynamic>> updateUser(String userId, Map<String, dynamic> userData) async {
  final response = await supabase
      .from('anilist_users')
      .update(userData)
      .eq('id', userId)
      .select()
      .single();
  
  if (response.error != null) {
    throw response.error!;
  }
  
  return response.data as Map<String, dynamic>;
}
```

## Error Handling

The API returns standard HTTP status codes:

- 200: OK - Request succeeded
- 201: Created - Resource created successfully
- 400: Bad Request - Invalid input
- 401: Unauthorized - Authentication required
- 403: Forbidden - Insufficient permissions
- 404: Not Found - Resource not found
- 409: Conflict - Request conflicts with current state
- 429: Too Many Requests - Rate limit exceeded
- 500: Internal Server Error - Server error

Errors will include a JSON response with details about what went wrong.

## Rate Limits

Currently, KamiDB imposes the following rate limits:
- 100 requests per minute per IP address for anonymous users
- 1000 requests per minute per IP address for authenticated users

## Security Considerations

- Never expose your service role key in client applications
- Store sensitive user data securely
- Implement proper authentication in your applications
- Use HTTPS for all API requests
- Be mindful of CORS restrictions when making requests from browsers 